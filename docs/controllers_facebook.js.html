<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>controllers/facebook.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Attachment_Controller.html">Attachment_Controller</a><ul class='methods'><li data-type='method'><a href="Attachment_Controller.html#getAttachment">getAttachment</a></li><li data-type='method'><a href="Attachment_Controller.html#getAttachmentUrl">getAttachmentUrl</a></li></ul></li><li><a href="Bot_Controller.html">Bot_Controller</a><ul class='methods'><li data-type='method'><a href="Bot_Controller.html#processEvent">processEvent</a></li></ul></li><li><a href="Facebook_Controller.html">Facebook_Controller</a><ul class='methods'><li data-type='method'><a href="Facebook_Controller.html#setGreetingText">setGreetingText</a></li></ul></li><li><a href="Menu_Controller.html">Menu_Controller</a><ul class='methods'><li data-type='method'><a href="Menu_Controller.html#getFacebookButtons">getFacebookButtons</a></li><li data-type='method'><a href="Menu_Controller.html#getFacebookMenu">getFacebookMenu</a></li><li data-type='method'><a href="Menu_Controller.html#getMenu">getMenu</a></li></ul></li><li><a href="NGINB.html">NGINB</a><ul class='methods'><li data-type='method'><a href="NGINB.html#addEventListener">addEventListener</a></li><li data-type='method'><a href="NGINB.html#configure">configure</a></li><li data-type='method'><a href="NGINB.html#dispatchEvent">dispatchEvent</a></li><li data-type='method'><a href="NGINB.html#getBotController">getBotController</a></li><li data-type='method'><a href="NGINB.html#getBotResponse">getBotResponse</a></li><li data-type='method'><a href="NGINB.html#getFacebookController">getFacebookController</a></li><li data-type='method'><a href="NGINB.html#getMenuController">getMenuController</a></li><li data-type='method'><a href="NGINB.html#getPageController">getPageController</a></li><li data-type='method'><a href="NGINB.html#getUserController">getUserController</a></li><li data-type='method'><a href="NGINB.html#sendMessengeEvent">sendMessengeEvent</a></li><li data-type='method'><a href="NGINB.html#setEntities">setEntities</a></li></ul></li><li><a href="Page_Controller.html">Page_Controller</a><ul class='methods'><li data-type='method'><a href="Page_Controller.html#getFacebookPageByLanguage">getFacebookPageByLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageInfo">getFacebookPageInfo</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageLanguage">getFacebookPageLanguage</a></li><li data-type='method'><a href="Page_Controller.html#getFacebookPageToken">getFacebookPageToken</a></li><li data-type='method'><a href="Page_Controller.html#isValidPage">isValidPage</a></li></ul></li><li><a href="User_Controller.html">User_Controller</a><ul class='methods'><li data-type='method'><a href="User_Controller.html#addUser">addUser</a></li><li data-type='method'><a href="User_Controller.html#getNewUser">getNewUser</a></li><li data-type='method'><a href="User_Controller.html#getUser">getUser</a></li><li data-type='method'><a href="User_Controller.html#getUserByName">getUserByName</a></li><li data-type='method'><a href="User_Controller.html#getUserData">getUserData</a></li><li data-type='method'><a href="User_Controller.html#getUsers">getUsers</a></li><li data-type='method'><a href="User_Controller.html#updateUser">updateUser</a></li></ul></li></ul><h3>Mixins</h3><ul><li><a href="Rivescript_Tags.html">Rivescript_Tags</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Bot">Bot</a></li><li><a href="global.html#BotConfig">BotConfig</a></li><li><a href="global.html#DatabaseConfig">DatabaseConfig</a></li><li><a href="global.html#DispatcherConfig">DispatcherConfig</a></li><li><a href="global.html#EntityConfig">EntityConfig</a></li><li><a href="global.html#Event">Event</a></li><li><a href="global.html#FacebookConfig">FacebookConfig</a></li><li><a href="global.html#Options">Options</a></li><li><a href="global.html#PageConfig">PageConfig</a></li><li><a href="global.html#PageObjectConfig">PageObjectConfig</a></li><li><a href="global.html#UserResponse">UserResponse</a></li><li><a href="global.html#UserUpdateResponse">UserUpdateResponse</a></li><li><a href="global.html#WordConfig">WordConfig</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/facebook.js</h1>
    

    



    
<section>
    <article>
        <pre class="prettyprint source linenums"><code>var promise 		= require('bluebird');
var request 		= require('request');
var JSONbig 		= require('json-bigint');

var botconfig   	= require('../config/botconfig');

var fbmessageutil 	= require('../utils/fbmessageutil');
var messagesutil 	= require('../utils/messagesutil');
var debugutil 		= require('../utils/debugutil');

var pagectl			= false;
var menuctl			= false;
var attachmentctl	= false;

exports = module.exports = function(pagectl, attachmentctl, menuctl)
{
	return new Facebookctl(pagectl, attachmentctl, menuctl);
}

/**
 * @constructs Facebook_Controller
 * @public
 * @param {Page_Controller} page_controller - A NGINB page controller
 * @param {Attachment_Controller} attachment_controller - A NGINB attachment controller
 * @param {Menu_Controller} menu_controller - A NGINB menu controller
 */
function Facebookctl(page_controller, attachment_controller, menu_controller)
{
	pagectl = page_controller || require('./page')();
	attachmentctl = attachment_controller || require('./attachment')();
	menuctl = menu_controller || require('./menu')();
}

/**
 * Sets the greetings text of the facebook messenger bot
 * @param {PageConfig} page - A PageConfig object
 * @param {Array|tring} greetings - A String or an Array with greetings messages and locations
 * @return {Object} A bluebird promise facebook response object
 */
Facebookctl.prototype.setGreetingText = function setGreetingText(page, greetings)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		greetings = (greetings.length!=undefined) ? greetings : [greetings];

		var json =
		{
			greeting: greetings
		}

		self.setMessengerProfile(page, json)
		.then(function(result)
		{
			resolve(result);
		});
	});
}

Facebookctl.prototype.setStartButton = function setStartButton(page, payload)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		var json =
		{
			get_started: {"payload": payload}
		}

		self.setMessengerProfile(page, json)
		.then(function(result)
		{
			resolve(result);
		});
	});
}

Facebookctl.prototype.setPersistentMenu = function setPersistentMenu(page, menu)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		var menu_data = (menu.data!=undefined &amp;&amp; menu.data.length!=undefined &amp;&amp; menu.data.length>0) ? menu.data : [];
		var json = {persistent_menu:[]};

		if(menu.type!=undefined)
		{
			if(menu.type=='fixed')
			{
				var menu_buttons = (menu_data.hasOwnProperty('buttons') &amp;&amp; menu_data.buttons.length>0) ? menu_data.buttons : [{"type":"postback", "title":"OK", "payload":"ok"}];
				var buttons = menuctl.getFacebookButtons(menu_buttons);

				json = {persistent_menu: buttons}
			}
			else if(menu.type=='persistent_menu')
			{
				json = {persistent_menu: menu_data}
			}

			self.setMessengerProfile(page, json)
			.then(function(result)
			{
				resolve(result);
			});
		}
		else
		{
			resolve(false);
		}
	});
}

//action: add or remove
Facebookctl.prototype.domainWhitelisting = function domainWhitelisting(page, domainArray)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		domainArray = domainArray.length!=undefined ? domainArray : [domainArray];
		var json = {whitelisted_domains: domainArray};

		self.setMessengerProfile(page, json)
		.then(function(result)
		{
			resolve(result);
		});
	});
}

Facebookctl.prototype.setMessengerProfile = function setMessengerProfile(page, json)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		request(
		{
			method: 'POST',
			uri: botconfig.facebook.graph_url + "/" + botconfig.facebook.version + "/me/messenger_profile?access_token=" + page.token,
			json: json
		},
		function (error, response, body)
		{
			var message = messagesutil.getMessage(error, response, body, 'Set Thread Settings Error');
			resolve(message);
		});
	});
}

Facebookctl.prototype.deleteMessengerProfile = function setMessengerProfile(page, fields)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		request(
		{
			method: 'DELETE',
			uri: botconfig.facebook.graph_url + "/" + botconfig.facebook.version + "/me/messenger_profile?access_token=" + page.token,
			json: {fields:fields}
		},
		function (error, response, body)
		{
			var message = messagesutil.getMessage(error, response, body, 'Set Thread Settings Error');
			resolve(message);
		});
	});
}

Facebookctl.prototype.getMessengerProfile = function setMessengerProfile(page, fields)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		request(
		{
			method: 'GET',
			uri: botconfig.facebook.graph_url + "/" + botconfig.facebook.version + "/me/messenger_profile?fields="+fields+"&amp;access_token=" + page.token,
			json: json
		},
		function (error, response, body)
		{
			var message = messagesutil.getMessage(error, response, body, 'Set Thread Settings Error');
			resolve(message);
		});
	});
}

Facebookctl.prototype.doSubscribeRequest = function doSubscribeRequest(page)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		request(
		{
			method: 'POST',
			uri: botconfig.facebook.graph_url + "/" + botconfig.facebook.version + "/me/subscribed_apps?access_token=" + page.token
		},
		function (error, response, body)
		{
			var message = messagesutil.getMessage(error, response, body, 'Do Subscribe Error');
			resolve(message);
		});
	});
}

Facebookctl.prototype.facebookLogin = function functionName(req, res, redirect_url, scope)
{
	var self = this;
	var facebookUrl = "https://www.facebook.com";

	if (req.device.type!='desktop')
		facebookUrl = "https://m.facebook.com";

	var url = facebookUrl+'/'+botconfig.facebook.version+'/dialog/oauth?';
	var params = 'client_id='+botconfig.facebook.login_app_id+'&amp;redirect_uri='+encodeURIComponent(redirect_url)+'&amp;scope='+scope;

	res.redirect(url+params);
}

Facebookctl.prototype.getFacebookToken = function getFacebookToken(code, redirect_url, callback_data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		var params = 'client_id='+botconfig.facebook.login_app_id+'&amp;redirect_uri='+encodeURIComponent(redirect_url)+'&amp;client_secret='+botconfig.facebook.login_app_secret+'&amp;code='+code;
		request(
		{
			method: 'GET',
			uri: botconfig.facebook.graph_url + "/" + botconfig.facebook.version + "/oauth/access_token?"+params
		},
		function (error, response, body)
		{
			var message = messagesutil.getMessage(error, response, body, 'Get Token Error');
			message.callback_data = callback_data;
			resolve(message);
		});
	});
}

Facebookctl.prototype.getFacebookUserDataByCode = function requestUserData(code, redirect_url, callback_data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		self.getFacebookToken(code, redirect_url, callback_data)
		.then(function(token_response)
		{
			var data = token_response.data.body;

			if(typeof(data)=='string')
				data = JSONbig.parse(data);

			self.getFacebookUserData(data.access_token, token_response.callback_data)
			.then(function(fb_response)
			{
				var fb_data = fb_response.data.body;

				if(typeof(fb_data)=='string')
					fb_data = JSONbig.parse(fb_data);

				var picture = botconfig.facebook.graph_url + "/" + fb_data.id + "/picture?type=large";
				fb_data.profile_pic = picture;
				fb_data.facebook_id = fb_data.id;
				fb_data.sender_id = fb_response.callback_data.pid;
				fb_data.page_id = fb_response.callback_data.page_id;

				delete fb_data.id;
				delete fb_data.name;

				resolve({data:fb_data, callback_data:callback_data, access_token:data.access_token});
			});
		});
	});
}

Facebookctl.prototype.getFacebookUserData = function requestUserData(access_token, callback_data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		var fields = 'name,first_name,last_name,locale,gender,email,timezone';

		request(
		{
			method: 'GET',
			uri: botconfig.facebook.graph_url + "/" + botconfig.facebook.version + "/me?fields=" + fields + "&amp;access_token=" + access_token
		},
		function (error, response, body)
		{
			var message = messagesutil.getMessage(error, response, body, 'Set Thread Settings Error');
			message.callback_data = callback_data;
			resolve(message);
		});
	});
}

Facebookctl.prototype.requestUserData = function requestUserData(page, sender_id, callback_data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		var fields = 'first_name,last_name,profile_pic,locale,timezone,gender';

		request(
		{
			method: 'GET',
			uri: botconfig.facebook.graph_url + "/" + botconfig.facebook.version + "/"+sender_id+"?fields="+fields+"&amp;access_token=" + page.token
		},
		function (error, response, body)
		{
			var message = messagesutil.getMessage(error, response, body, 'Set Thread Settings Error');
			message.callback_data = callback_data;
			resolve(message);
		});
	});
}

Facebookctl.prototype.sendMessage = function sendMessage(page, sender, message_data, callback_data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		request(
		{
			url: botconfig.facebook.graph_url + "/" + botconfig.facebook.version + "/me/messages",
			qs: {access_token: page.token},
			method: 'POST',
			json:
			{
				recipient: {id: sender},
				message: message_data
			}
		}, function (error, response, body)
		{
			var message = messagesutil.getMessage(error, response, body, 'Error sending message');
			message.callback_data = callback_data;
			resolve(message);
		});
	});
}

Facebookctl.prototype.sendAction = function sendAction(page, sender, action, callback_data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		request(
		{
			url: botconfig.facebook.graph_url + "/" + botconfig.facebook.version + "/me/messages",
			qs: {access_token: page.token},
			method: 'POST',
			json: {
				recipient: {id: sender},
				sender_action: action
			}
		}, function (error, response, body)
		{
			var message = messagesutil.getMessage(error, response, body, 'Error sending action');
			message.callback_data = callback_data;
			resolve(message);
		});
	});
}

Facebookctl.prototype.getFacebookTemplate = function getFacebookTemplate(sender, page_id, message, lang, data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		var facebook_message = false;
		var menu_params = false;
		var params = (message.button_params) ? message.button_params : [];

		if(message.template)
		{
			if(typeof(message.template)=='string' || (typeof(message.template)=='object' &amp;&amp; message.template.length==undefined))
				menu_params = message.template;

			if(menu_params)
			{
				menuctl.getMenu(menu_params, lang)
				.then(function(menu)
				{
					facebook_message = menuctl.getFacebookMenu(menu, sender, page_id, data, params);
					resolve(facebook_message);
				});
			}
			else if(message.template.length!=undefined)
			{
				var elements = [];
				for (var i = 0; i &lt; message.template.length; i++)
				{
					var element = message.template[i];
					var buttons = [];

					if(element.hasOwnProperty('buttons'))
						buttons = menuctl.getFacebookButtons(element.buttons, sender, page_id, data, params);

					element.buttons = buttons;
					elements.push(element);
				}

				facebook_message = fbmessageutil.genericTemplate(elements);
				resolve(facebook_message);
			}
			else
				resolve(false);
		}
		else
			resolve(false);
	});
}

Facebookctl.prototype.getFacebookMessage = function getFacebookMessage(sender, page_id, message, lang, data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		var facebook_message = {text: ''};
		var menu_params = false;

		if(message.quickreply)
		{
			var rpl_items = message.quickreply;
			var msg = {text: ''};
			var params = (message.quickreply_params) ? message.quickreply_params : [];
			var menu = false;

			if(typeof(message.quickreply)=='string' || (typeof(message.quickreply)=='object' &amp;&amp; message.quickreply.length==undefined))
				menu_params = message.quickreply;

			menuctl.getMenu(menu_params, lang)
			.then(function(menu)
			{
				if(menu)
				{
					if(menu.data[0].hasOwnProperty('quick_replies'))
						rpl_items = menu.data[0].quick_replies;
					else
						rpl_items = [];

					msg = menu.data[0].hasOwnProperty('text') ? {text: menu.data[0].text} : msg;
				}

				rpl_items = menuctl.getFacebookButtons(rpl_items, sender, page_id, data, params);

				if(message.text!=undefined &amp;&amp; message.text!='')
					msg = {text: message.text};

				var items = fbmessageutil.quickReplyItems(rpl_items);
				facebook_message = fbmessageutil.quickReply(msg, items);

				resolve(facebook_message);
			});
		}
		else if(message.button)
		{
			var bt_items = message.button;
			var msg = '';
			var params = (message.button_params) ? message.button_params : [];
			var menu = false;

			if(typeof(message.button)=='string' || (typeof(message.button)=='object' &amp;&amp; message.button.length==undefined))
				menu_params = message.button;

			menuctl.getMenu(menu_params, lang)
			.then(function(menu)
			{
				if(menu)
				{
					if(menu.data[0].hasOwnProperty('buttons'))
						bt_items = menu.data[0].buttons;
					else
						bt_items = [];

					msg = menu.data[0].hasOwnProperty('title') ? menu.data[0].title : msg;
				}

				if(message.text!=undefined &amp;&amp; message.text!='')
					msg = message.text;

				var buttons = menuctl.getFacebookButtons(bt_items, sender, page_id, data, params);
				facebook_message = fbmessageutil.messageButtons(msg, buttons);

				resolve(facebook_message);
			});
		}
		else if(message.text!=undefined)
		{
			if(!debugutil.attachment_debug &amp;&amp; message.hasOwnProperty('attachment_data') &amp;&amp; message.text=='attachment')
			{
				var attachement = message.attachment_data;

				if(typeof(attachement)=='string')
					attachement = attachmentctl.getAttachment(attachement);

				facebook_message = fbmessageutil.attachment(attachement.type, attachmentctl.getAttachmentUrl(attachement.url));
			}
			else
				facebook_message.text = message.text;

			resolve(facebook_message);
		}
	});
}

Facebookctl.prototype.messengerEvent = function messengerEvent(data)
{
	var self = this;
	return new promise(function(resolve, reject)
	{
		if(data.type!=undefined &amp;&amp; data.type=='website')
		{
			var response_event =
			{
				fb_page: false,
				sender: data.sender,
				type: 'message',
				text: data.text,
				id: '',
				lang: false
			}

			resolve(response_event);
		}
		else
		{
			if (data.entry)
			{
				var entries = data.entry;
				var entries_length = entries.length;

				for (var i = 0; i &lt; entries_length; i++)
				{
					var messaging_events = entries[i].messaging;
					if (messaging_events)
					{
						var msg_events_count = messaging_events.length;
						var response_events = [];
						var promises = [];

						for (var j = 0; j &lt; msg_events_count; j++)
						{
							var messaging_event = messaging_events[j];

							if((messaging_event.message &amp;&amp; !messaging_event.message.is_echo) || messaging_event.postback)
							{
								var sender = messaging_event.sender.id.toString();
								var recipient = messaging_event.recipient.id.toString();

								promises.push
								(
									pagectl.getFacebookPageInfo(recipient, messaging_event)
									.then(function(response)
									{
										var messaging_event = response.data;

										if(response.page)
										{
											var lang = response.page.language;

											var attachmentType = '';
											var attachmentPayload = '';
											var id = '';
											var type = '';
											var text = '';

											if(messaging_event.message &amp;&amp; messaging_event.message.attachments)
											{
												for (var i = 0; i &lt; messaging_event.message.attachments.length; i++)
												{
													var attachment = messaging_event.message.attachments[i];
													attachmentType = attachment.type;
													attachmentPayload = attachment.payload.url;

													if(attachment.payload.hasOwnProperty('sticker_id'))
														id = attachment.payload.sticker_id;
												}
											}

											if(messaging_event.message &amp;&amp; messaging_event.message.text)
											{
												type = 'message';
												text = messaging_event.message.text;
											}
											else if(messaging_event.postback &amp;&amp; messaging_event.postback.payload)
											{
												type = 'payload';
												text = messaging_event.postback.payload;
											}
											else if(attachmentType!='')
											{
												type = 'attachment';
												text = attachmentPayload;
											}

											if(messaging_event.message &amp;&amp; messaging_event.message.quick_reply!=undefined)
											{
												//type = 'quick_reply';
												type = 'payload';
												text = messaging_event.message.quick_reply.payload;
											}

											var response_event =
											{
												fb_page: response.page,
												sender: sender,
												type: type,
												text: text,
												id: id,
												lang: lang
											}
											response_events.push(response_event);
										}
									})
								);
							}
						}

						promise.all(promises)
						.then(function()
						{
						    resolve(response_events);
						});
					}
				}
			}
			else
				resolve(false);
		}
	});
}
</code></pre>
    </article>
</section>





</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Mar 26 2017 18:41:56 GMT-0300 (E. South America Standard Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
